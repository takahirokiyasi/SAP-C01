# AWS Config
イベントの記録ではなく、選択されたAWSリソース（EC2サーバなど）の構成情報の記録や監視ができるサービス。
システム構成図を自動で作ってくれるイメージ。構成変更を何に対していつ何をしたか自動で記録してくれ確認できる
CloudTrailと連携してるので誰が構成変更のイベント起こしたのか見れる。

管理できるAWSリソースはセキュリティグループ・S3バケット・EC2インスタンス・Lambda・WAF・ELB・VPCなど60のリソースに対応

以下のことができる。
- AWS リソースの設定が最適な設定であるかどうかを評価する。（リソースの管理）
- AWS アカウントに関連付けられているサポート対象リソースの現在の設定のスナップショットを取得する。
- アカウント内にある 1 つ以上のリソースの設定を取得する。
- 1 つ以上のリソースの設定履歴を取得する。
- SQLクエリで構成情報を検索できる
- リソースが作成、変更、または削除されるたびに通知を受け取る。（設定変更の管理とトラブルシューティング・監査・コンプライアンス）
- リソース間の関係も見れる(特定のセキュリティグループを使用するすべてのリソースを確認する場合など)。（セキュリティ分析）
- すでに削除したEC2の設定情報も確認できる

SSMイベントリで収集した情報もConfigで記録してる
CloudFrontなどグローバルサービスはバージニア北部でサポート
保存先のS3バケットは特定の人しかアクセスできず、改竄ができない場所へ保存すること

## Configの各機能
### ストリーム
リソースが作成・変更・削除される度に作成され、構成ストリームに追加される
### ヒストリー
リソースの設定履歴を保存しておける
### スナップショット
ある時点でのリソース構成情報を保存できる

## Config Rules
構成の評価する機能
ルールに違反した構成変更が行われた場合に管理者に通知することができ、
タグが付与されていないリソースが作成されていないか監視することができたりする。

マネージドルールとカスタムルールがある。
カスタムルールはLambda関数をベースにルールを作成し、ルールにLambdaのARNを紐づけ、ルールの評価のタイミングの設定（トリガタイプ）を行う（AWS Config　Rule Development Kitというカスタムルールを作成するツールがある）

ルールの評価のタイミングは設定変更時と定期実行がある

例）
- 全てのEBSボリュームが暗号化されているか encrypted-volumes
- EC2にタグが付与されているかとか required-tags
- EC2はSystemManagerで管理されているどうか　ec2-instance-managed-by-ssm
- 実行中のインスタンスで使用されているAMIは社内で承認ずみのものか　approved-amis-by-id
- VPC Flow Logs（パケットログ取得）が有効になっているか　vpc-flow-logs-enabled
- S3バケットでパブリック読み込みが許可されていないことを確認　s3-bucket-public-read-prohibited
- 有効なアクセスキーが、指定日以内にローテーションされているかどうか　access-keys-rotated

### 修正アクション
コンプライアンス違反のリソースに対してAWS System Manager Automationドキュメントを利用したカスタムの修正アクションを設定できる。
またCloud Watch Eventsでコンプライアンス違反の検出イベントを発火し、Lambdaを実行してより細かい修正アクションを行うことも可能
Slackへの通知とかもできる

# 適合パック（Conformance Pack）
複数のConfig Rule と修復アクションをまとめることができるもの
テンプレートがあってベストプラクティスを適用できる

### AWS Config Rules Repository
コミュニティベースでカスタマイズされたAWS Config RulesがGitHub上で公開されている

例）
- Lambda関数がVPCに紐づいているか
- ALBがHTTPSリダイレクト有効か

## マルチリージョン・マルチアカウント
AWS Configのマルチアカウント、マルチリージョンのデータ集約により、複数のアカウントおよびリージョンからのAWS Configデータを単一のアカウントに集約できる。
マルチアカウント、マルチリージョンのデータ集約は、中央のIT管理者が企業内の複数のAWSアカウントのコンプライアンスを監視するのに役立つ

# AWS X-Ray
本番環境や分散アプリケーション (マイクロサービスアーキテクチャを使用して構築されたアプリケーションなど) を分析およびデバッグできる。

# CloudWatch
## CloudWatch Logs
### CloudWatch Logs Insights
クラウドスケールで動作するよう設計され、セットアップやメンテナンスが不要なフルマネージドのサービス。
大量のログを数秒で走査し、インタラクティブなクエリの実行と可視化を提供する
フローログではトラフィックのログしか確認できるが、オペレーティングシステムのログファイルは収集することはできない

# Cloud Watch エージェント
EC2のメトリクスとログを収集できる。
オンプレミスサーバーからもメトリクスを収集できる。（Linux Widows）
CloudWatch エージェントによって収集されたログは、以前の CloudWatch Logs エージェントによって収集されたログと同様に、処理されて Amazon CloudWatch Logs に格納される

## ダッシュボード
メトリクスのところで特定のリージョンを選択しながらグラフを作りダッシュボードを作ることができる。（複数リージョンのメトリクスを同一ダッシュボードに表示可能）

## EC2Rescue for Windows Server 
Amazon EC2 Windows Server インスタンス上で動作し、潜在的な問題の診断とトラブルシューティングを行うことができる使いやすいツールです。ログファイルを収集して問題を解決するだけでなく、問題がありそうな部分をプロアクティブに検索することができます。他のインスタンスから Amazon EBS ルートボリュームを調べて、そのボリュームを使用する Windows Server インスタンスをトラブルシューティングするために必要なログを収集することもできます。したがって、EC2Rescueツールを使用して分析のためにオペレーティングシステムのログファイルを収集することで原因を特定します。

# PutMetricData API コール
1秒あたり1000レコードを収集しています。 そして、これをカスタム名前空間を使用してCloudWatchにこれらのデータを送信したい
PutMetricData API コールを使うことによって集約したデータを送ることができる
大量のメトリクスデータを効率よくインジェストしながら、API コール数が減ることでコストを削減することもできる

# AWS Organizations
## 新規AWSアカウントの作成
マスターアカウントからのみ組織のメンバーアカウントを作成できる。
メンバーアカウントに与えるIAMロール・メールアドレス・アカウント名・billingに対するアクセス権を設定する。

## SCP
制御できるのは各リソースに対しての権限の最大範囲（S3に対する読み取り・書き込み・管理全て）だけで、別にIAMグループ＋IAMロールとかでS3読み取りのみの制限を加える必要がある。
RootとOUとAWSアカウントに付与可能
Rootに付与した場合、全ての組織のアカウントにSCPを付与していることになる

実際のアクセス許可は付与できない。
IAMユーザーおよびロールに付与されるポリシーに対してガードレール的な役割や、制限を設定する

AWS OrganizationsのSCPは`サービスにリンクされたIAMロール`には影響しないようになっている。 そのため、サービスにリンクされたロールにより、他のAWSサービスの利用を継続することが可能。したがって、SCPを適用した後も、IAMロールによって新アカウントは実行が制限されているはずのECSの実行アクションを操作できる状態が継続することができる

### ブラックリスト方式
OU,AWSアカウントの両方でFullAWSAccess権限を持ちつつ不要な操作をOU側のブラックリストで拒否するパターン　
### ホワイトリスト
FullAWSAccessをデタッチして許可したい権限だけ許可する
OUに対してホワイトリストでSCPを設定することが多い。

## 統合請求（一括請求）
AWS Organizationsを利用して一括請求を設定すると、ボリュームディスカウントやリザーブドインスタンスの割引適用を登録されたメンバーアカウント全体で共有することができる
S3とかでは５０TB以上で割引されるのでボリュームディスカウントされる
### リザーブドインスタンス
開発アカウントが購入した同じインスタンスタイプのリザーブドインスタンスを設置しているAZでインスタンスを起動している本番環境アカウントにおいて、統合請求による価格割引の恩恵を受けることができることになる（開発アカウントでインスタンスの使用なしの時）

## ログ取得
AWS Organizationsを利用してマスターアカウントのCloudTrailにおいて組織の証跡を有効化することで、全てのメンバーアカウントでのログ取得を可能にすることができます。それにより、各AWSアカウントに関連するログをプライマリアカウントの単一のS3バケットに配信する設定も可能

## メンバーアカウント削除する時のアクセス拒否への対処
メンバーアカウントをマスターアカウントとして削除しようとすると、「アクセスが拒否されました」というメッセージが表示される原因は次の２つです。

- メンバーアカウントでの請求を IAM ユーザーアクセスで有効にした後でのみ、メンバーアカウントを削除できます。
- アカウントがスタンドアロンアカウントとして動作するために必要な情報を持っている場合にのみ、組織からアカウントを削除できます。

AWS Organizations コンソール、API、AWS CLI コマンドを使用して組織内にアカウントを作成した場合、その情報が自動的に収集されるわけではありません。
スタンドアロンとして使用する各アカウントについて、まず AWS カスタマーアグリーメントに同意してサポートプランを選択し、必須の連絡先情報を入力および確認して、支払方法を入力する必要があります。

