# AWS Config
イベントの記録ではなく、選択されたAWSリソース（EC2サーバなど）の構成情報の記録や監視ができるサービス。
システム構成図を自動で作ってくれるイメージ。構成変更を何に対していつ何をしたか自動で記録してくれ確認できる
CloudTrailと連携してるので誰が構成変更のイベント起こしたのか見れる。

管理できるAWSリソースはセキュリティグループ・S3バケット・EC2インスタンス・Lambda・WAF・ELB・VPCなど60のリソースに対応

以下のことができる。
- AWS リソースの設定が最適な設定であるかどうかを評価する。（リソースの管理）
- AWS アカウントに関連付けられているサポート対象リソースの現在の設定のスナップショットを取得する。
- アカウント内にある 1 つ以上のリソースの設定を取得する。
- 1 つ以上のリソースの設定履歴を取得する。
- SQLクエリで構成情報を検索できる
- リソースが作成、変更、または削除されるたびに通知を受け取る。（設定変更の管理とトラブルシューティング・監査・コンプライアンス）
- リソース間の関係も見れる(特定のセキュリティグループを使用するすべてのリソースを確認する場合など)。（セキュリティ分析）
- すでに削除したEC2の設定情報も確認できる

SSMイベントリで収集した情報もConfigで記録してる
CloudFrontなどグローバルサービスはバージニア北部でサポート
保存先のS3バケットは特定の人しかアクセスできず、改竄ができない場所へ保存すること

## Configの各機能
### ストリーム
リソースが作成・変更・削除される度に作成され、構成ストリームに追加される
### ヒストリー
リソースの設定履歴を保存しておける
### スナップショット
ある時点でのリソース構成情報を保存できる

## Config Rules
構成の評価する機能
ルールに違反した構成変更が行われた場合に管理者に通知することができ、
タグが付与されていないリソースが作成されていないか監視することができたりする。

マネージドルールとカスタムルールがある。
カスタムルールはLambda関数をベースにルールを作成し、ルールにLambdaのARNを紐づけ、ルールの評価のタイミングの設定（トリガタイプ）を行う（AWS Config　Rule Development Kitというカスタムルールを作成するツールがある）

ルールの評価のタイミングは設定変更時と定期実行がある

例）
- 全てのEBSボリュームが暗号化されているか encrypted-volumes
- EC2にタグが付与されているかとか required-tags
- EC2はSystemManagerで管理されているどうか　ec2-instance-managed-by-ssm
- 実行中のインスタンスで使用されているAMIは社内で承認ずみのものか　approved-amis-by-id
- VPC Flow Logs（パケットログ取得）が有効になっているか　vpc-flow-logs-enabled
- S3バケットでパブリック読み込みが許可されていないことを確認　s3-bucket-public-read-prohibited
- 有効なアクセスキーが、指定日以内にローテーションされているかどうか　access-keys-rotated

### 修正アクション
コンプライアンス違反のリソースに対してAWS System Manager Automationドキュメントを利用したカスタムの修正アクションを設定できる。
またCloud Watch Eventsでコンプライアンス違反の検出イベントを発火し、Lambdaを実行してより細かい修正アクションを行うことも可能
Slackへの通知とかもできる

# 適合パック（Conformance Pack）
複数のConfig Rule と修復アクションをまとめることができるもの
テンプレートがあってベストプラクティスを適用できる

### AWS Config Rules Repository
コミュニティベースでカスタマイズされたAWS Config RulesがGitHub上で公開されている

例）
- Lambda関数がVPCに紐づいているか
- ALBがHTTPSリダイレクト有効か

## マルチリージョン・マルチアカウント
AWS Configのマルチアカウント、マルチリージョンのデータ集約により、複数のアカウントおよびリージョンからのAWS Configデータを単一のアカウントに集約できる。
マルチアカウント、マルチリージョンのデータ集約は、中央のIT管理者が企業内の複数のAWSアカウントのコンプライアンスを監視するのに役立つ

# AWS X-Ray
本番環境や分散アプリケーション (マイクロサービスアーキテクチャを使用して構築されたアプリケーションなど) を分析およびデバッグできる。

# CloudWatch
## CloudWatch Logs
### CloudWatch Logs Insights
クラウドスケールで動作するよう設計され、セットアップやメンテナンスが不要なフルマネージドのサービス。
大量のログを数秒で走査し、インタラクティブなクエリの実行と可視化を提供する
フローログではトラフィックのログしか確認できるが、オペレーティングシステムのログファイルは収集することはできない

# Cloud Watch エージェント
EC2のメトリクスとログを収集できる。
オンプレミスサーバーからもメトリクスを収集できる。（Linux Widows）
CloudWatch エージェントによって収集されたログは、以前の CloudWatch Logs エージェントによって収集されたログと同様に、処理されて Amazon CloudWatch Logs に格納される

## ダッシュボード
メトリクスのところで特定のリージョンを選択しながらグラフを作りダッシュボードを作ることができる。（複数リージョンのメトリクスを同一ダッシュボードに表示可能）

## EC2Rescue for Windows Server 
Amazon EC2 Windows Server インスタンス上で動作し、潜在的な問題の診断とトラブルシューティングを行うことができる使いやすいツールです。ログファイルを収集して問題を解決するだけでなく、問題がありそうな部分をプロアクティブに検索することができます。他のインスタンスから Amazon EBS ルートボリュームを調べて、そのボリュームを使用する Windows Server インスタンスをトラブルシューティングするために必要なログを収集することもできます。したがって、EC2Rescueツールを使用して分析のためにオペレーティングシステムのログファイルを収集することで原因を特定します。

# PutMetricData API コール
1秒あたり1000レコードを収集しています。 そして、これをカスタム名前空間を使用してCloudWatchにこれらのデータを送信したい
PutMetricData API コールを使うことによって集約したデータを送ることができる
大量のメトリクスデータを効率よくインジェストしながら、API コール数が減ることでコストを削減することもできる

# AWS Organizations
Organizationsには「全ての機能」と「一括請求機能のみ」の二種類の機能セットがある。
## 新規AWSアカウントの作成
マスターアカウントからのみ組織のメンバーアカウントを作成できる。
メンバーアカウントに与えるIAMロール・メールアドレス・アカウント名・billingに対するアクセス権を設定する。

## SCP
制御できるのは各リソースに対しての権限の最大範囲（S3に対する読み取り・書き込み・管理全て）だけで、別にIAMグループ＋IAMロールとかでS3読み取りのみの制限を加える必要がある。
RootとOUとAWSアカウントに付与可能
Rootに付与した場合、全ての組織のアカウントにSCPを付与していることになる

実際のアクセス許可は付与できない。
IAMユーザーおよびロールに付与されるポリシーに対してガードレール的な役割や、制限を設定する

AWS OrganizationsのSCPは`サービスにリンクされたIAMロール`には影響しないようになっている。 そのため、サービスにリンクされたロールにより、他のAWSサービスの利用を継続することが可能。したがって、SCPを適用した後も、IAMロールによって新アカウントは実行が制限されているはずのECSの実行アクションを操作できる状態が継続することができる

### ブラックリスト方式
OU,AWSアカウントの両方でFullAWSAccess権限を持ちつつ不要な操作をOU側のブラックリストで拒否するパターン　
### ホワイトリスト
FullAWSAccessをデタッチして許可したい権限だけ許可する
OUに対してホワイトリストでSCPを設定することが多い。

## 統合請求（一括請求）
AWS Organizationsを利用して一括請求を設定すると、ボリュームディスカウントやリザーブドインスタンスの割引適用を登録されたメンバーアカウント全体で共有することができる
S3とかでは５０TB以上で割引されるのでボリュームディスカウントされる
### リザーブドインスタンス
開発アカウントが購入した同じインスタンスタイプのリザーブドインスタンスを設置しているAZでインスタンスを起動している本番環境アカウントにおいて、統合請求による価格割引の恩恵を受けることができることになる（開発アカウントでインスタンスの使用なしの時）

## ログ取得
AWS Organizationsを利用してマスターアカウントのCloudTrailにおいて組織の証跡を有効化することで、全てのメンバーアカウントでのログ取得を可能にすることができます。それにより、各AWSアカウントに関連するログをプライマリアカウントの単一のS3バケットに配信する設定も可能

## メンバーアカウント削除する時のアクセス拒否への対処
メンバーアカウントをマスターアカウントとして削除しようとすると、「アクセスが拒否されました」というメッセージが表示される原因は次の２つです。

- メンバーアカウントでの請求を IAM ユーザーアクセスで有効にした後でのみ、メンバーアカウントを削除できます。
- アカウントがスタンドアロンアカウントとして動作するために必要な情報を持っている場合にのみ、組織からアカウントを削除できます。

AWS Organizations コンソール、API、AWS CLI コマンドを使用して組織内にアカウントを作成した場合、その情報が自動的に収集されるわけではありません。
スタンドアロンとして使用する各アカウントについて、まず AWS カスタマーアグリーメントに同意してサポートプランを選択し、必須の連絡先情報を入力および確認して、支払方法を入力する必要があります。

## タグポリシー
組織のアカウント内のリソース間でタグづけを標準化するためのもの。タグポリシーでは、リソースのタグ付けの際に適用されるタグ付けルールを指定する

# AWS Systems Manager（SSM）

a. マネージドインスタンス：SSM管理下のインスタンス
マネージドインスタンスにする方法
1. SSM Agentの導入
1. SSM APIへの経路確保
1. IAMロールの付与（EC2にSSMへのアクセスを許可　 AmazonSSMMAnagedInstanceCore）
→クイックセットアップ（高速セットアップ）でこれらを素早く設定できる
＋新規インスタンスも自動でマネージドインスタンスにすることが可能
＋2週間毎のSSM Agentの自動更新　３０分おきのイベントリ収集してくれる

オンプレの場合はTLS証明書をイントール＋SSMのアクティベーションコードの生成・設定が必要

b. リソースグループ（マネージドインスタンスのグループ化）
タグベースorCloudFormationで設定可能
タグエディター使えば便利

c. リソースの把握
SSM Explorer
SSM OpsCenter
SSM コンプライアンス

d.　インスタンスの中身を把握
SSM イベントリ

e. SSMで定型運用の実施
SSMドキュメントという運用処理を定義して実行（事前定義ドキュメントがあるので利用可能　JSON YAML）
1. Document Builerで自動化ドキュメント（Automation Playbook）を作成
1. 定義の実行　Run Commandでコマンドドキュメントを実行しShellScript等を実行 or　自動化（Automation）で自動化ドキュメントを実行しAWSサービスを操作
1. 定期実行したい場合はステートマネージャー（軽めの処理）orメンテナンスウィンドウ（重い処理）を使用

f.非定型な運用処理も
定型の処理ではなくサーバーの中でインタラクティブな作業をする時に便利な機能
SSM セッションマネージャーでインバウンドポートをセキュリティグループで開かなくてもSSH接続やRDPが可能になる

g. アプリケーションの設定管理も
パラメータストアで機密情報を管理
AppConfigでアプリケーションの設定だけをデプロイ（EC2、コンテナ、Lambdaにアプリケーションの再起動なしに設定を展開可能）

## SSM Agent
SSM Agentは、EC2 や オンプレミスサーバ にインストールすることのできるソフトウェアで、System Managerはこのソフトウェアを介して、これらのリソースの更新や管理、設定を行うことができる。
SSM AgentがSSM APIと連携し各種操作・コントロールを行う（AgentがSSM APIに対してポーリングで一方通行でOK）

SSM　APIへの経路を確保するには
パブリックサブネットにありインターネット通信可能な状態にする
パブリックサブネットではVPCエンドポイントを使ってSSM APIへ接続できるようにする
オンプレミスの場合はDirect ConnectかVPN

EC2上で提供されているWindows ServerやAmazon Linux、 Ubuntu ServerのAMIには、あらかじめSSM Agentがインストールされている。Systems Manager エンドポイントとの間でHTTPS通信を確立する必要があり、HTTP Proxy経由で通信する設定にすることもできる。なお、このエージェントの動作ログは以下の場所に格納されている。

/var/log/amazon/ssm/amazon-ssm-agent.log
/var/log/amazon/ssm/errors.log

SSM Agentの実行にはroot権限が付与されていることから、このSSM Agentを用いて SendCommand や StartSession コマンドを行うことが可能なAWS上のIAM ユーザ等の管理や権限付与には注意する必要がある。
SSM Agentをリリースのたびに更新し最新のバージョンを保持するためには、マネージメントコンソール上のマネージメントインスタンスのページから、Agent auto update (エージェントの自動更新)を選択する。

## SSM Explorer
インスタンス数やAMI別のインスタンス数などのリソース情報をレポートするダッシュボードサービス
クロスアカウント・クロスリージョンでリソースの状況を可視化できる。
オペレーションデータをOpsDataと呼ぶ
EC2情報とパッチコンプライアンス

## SSM OpsCenter
運用タスクリスト（OpsItems）を表示、調査、解決できるダッシュボード

## SSM コンプライアンス
コンプライアンスに準拠していないリソースを特定できるダッシュボード
デフォルトではパッチ適用情報・ステートマネージャの関連付け状況がコンプライアンスとして定義済み

## SSM インベントリ
EC2からSSM　インベントリでS3にデータを収集してAthena＋QuickSightを用いて分析・可視化できる
Configに構成情報を送信し、イベントリ情報の変更追跡が可能
マルチリージョン・マルチアカウントで分析可能
- OS上のアプリケーション一覧
- Windowsアップデート
- インスタンスの詳細（OS名　OSバージョン　最終起動）
- ファイル（実行中のプログラムも）
- AWSコンポーネント（EC2ドライバ）
などの情報を収集できる。

## SSM ドキュメント
オートメーション（自動化）
stepでそれぞれの処理を定義する。
スクリプトを実行する機能などがある。

## ステートマネージャー
サーバー群に対して`定期的`に処理を行うためのフレームワーク(軽めの処理)
サーバーの状態を確認・是正するための定期的な処理に向く（イベントリ収集・SSM　Agentの定期更新）
処理が失敗すると、コンプライアンスにレポートされる。

SSMの機能のRun Command と　自動化（Automation）を実行することができる

- 起動時に特定のソフトウェアを使用してインスタンスをブートストラップする
- 定義済みのスケジュールに従ってエージェント (SSM エージェント など) をダウンロードして更新する
- ネットワーク設定を構成する
- インスタンスを Windowsドメインに結合する (Windows Server インスタンスのみ)。
- ライフサイクルを通じてソフトウェアの更新でインスタンスをパッチする
- ライフサイクルを通じて Linux および Windows マネージドインスタンスでスクリプトを実行する

## SSM　メンテナンスウィンドウ
サーバー群に対して`定期的`に処理を行うためのフレームワーク（重めの処理）
サービス停止を伴うような比較的重たい処理に向く（OSパッチ適用、バックアップ取得）
ステートマネージャーと比べ精緻な制御が可能

Run　Commandと自動化（Automation）に加えてLambda,Step Functionも実行可能

メンテナンスウィンドウではS3バケット、SQSキュー、AWS KMSキーなど、多くのAWSリソースタイプでアクションをスケジュールすることもできます。

## Systems Manager Automation （自動化）
Amazon EC2 インスタンスおよび他の AWS リソースの一般的なメンテナンスとデプロイのタスクを簡素化します。
自動化ワークフローを構築して、インスタンスおよび AWS リソースを設定し、管理します。独自のカスタムワークフローを作成するか、または AWSによって管理された定義済みのワークフローを使用します。

### 通知の受信
Amazon CloudWatch Eventsを使用して自動化タスクおよびワークフローに関する通知を受信

## AWS Systems Manager Patch Manager
パッチルールの準拠の確認・インスタンスへのパッチ適用が可能
Patch Manager を使用して、オペレーティングシステムとアプリケーションの両方にパッチを適用することができる。
オペレーティングシステムのタイプ別に、Amazon EC2 インスタンスまたはオンプレミスサーバー、および仮想マシン (VM) にパッチを適用できる。

scanのみとScan＋Installが選択できる

### OS環境ごとのパッチ適用
パッチベースラインをOSの種類毎に作成し、パッチの適用ルールを定義しておく（OS＋用途別でも定義可能）
パッチベースラインはPatch Groupタグで紐付けることができる。

OS環境に応じたEC2インスタンスのタグ設定を実施し、AWS Systems Manager Patch Manager を利用してパッチベースラインを各環境に対して作成し、EC2インスタンスをパッチグループで分類して、パッチベースラインを適用することで、要件に合致したバッチ適用プロセスを整備することができる

## AWS SSM ディストリビューター
独自のソフトウェアパッケージの配布・インストールが可能
Linux/Windowsなど複数のプラットフォームに対応
AWS定義のソフトウェアパッケージも配布可能（CloudWatchAgent・EFSUtilsなど）

## SSM セッションマネージャー
シェルアクセスしてEC2をセットアップする時にインバウンドポートをセキュリティグループで開かなくてもシェルアクセスが可能になる
プライベートサブネットのインスタンスにもアクセス可能で踏み台サーバーが不要
- SSHがなくてもサーバ作業が可能になる
  EC2鍵管理をなくし、およびSSHポート開放も不要になる
- AWS ACCESS KEYの管理を減らせる可能性がある
  ローカルPCにAWS ACCESS KEYを置いてAWS作業を行っている場合、AWS ACCESS KEY自体を不要にできる。
  例えば、EC2にIAMロールを付与すれば、AWS ACCESS KEYがなくてもIAMロール権限でAWS CLIやSDKを実行できるが、セッションマネージャからEC2にログインしてAWS作業を行うようにすれば、AWS ACCESS KEYの管理が不要になる
- コマンドログがS3に格納されるので、監査の要件も満たせる

アクセス制御はIAMユーザーに対してIAMポリシーで指定する。

接続手段は２つ
1. SSM Agent経由で直接アクセス
1. SSM Agentでトンネルを作成してRDPでアクセス（接続履歴は残るが、操作履歴が残らない）
1. SSM Agentでトンネルを作成してSSHでアクセス（現在のクライアント運用そのままにSSH接続で操作できるしセキュリティグループは閉じておくことができる）


## AWS Systems Manager パラメータストア(SSM)
構成データ管理のための安全で階層的なストレージを提供し秘密の管理を行います。パスワード、データベース文字列、マシンイメージ(AMI)ID、およびパラメータ値としてのライセンスコードなどのデータを保管できます。  
プレーンテキストまたは暗号化データの形式で保管でき、参照できます。  
Systems Manager パラメータをスクリプト、コマンド、 SSM ドキュメント、構成、および自動化ワークフローを、 パラメーターの作成時に指定します。

### パラメータストアとSecret managerの違い
設定とシークレットにひとつのストアが欲しい場合、パラメータストア
ライフサイクル管理を備えたシークレット専用のストアが欲しい場合、Secret Manager
パラメータストアは無料、Secret Managerは有料

## SSM AppConfig
アプリケーションの設定だけをデプロイ（EC2、コンテナ、Lambdaにアプリケーションの再起動なしに設定を展開可能）
開発や本番など環境毎に異なる設定情報をデプロイできる。
設定情報はパラメータストアもしくはSSMドキュメントとして保管
展開前にバリデーションも実施できる
デプロイ戦略を定義でき、カナリアリリースも可能

キャンペーンなどでアプリケーションをデプロイするのではなく何らかの設定値を変更するだけの場合にAppConfigを使うと便利


