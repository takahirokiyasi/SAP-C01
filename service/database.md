# RDS
Amazon RDS は DB インスタンスへのシェルアクセスを提供していない。
また、高度な特権を必要とする特定のシステムプロシージャやテーブルへのアクセスを制限している。
そのためシェルアクセスが必要な案件ではEC2にDataBaseを立てることが必要

## Oracleの各種機能の対応について
### RAC(Oracle Real Application Cluster)は対応していないのでEC2のAMIを使用
RACはAWSではサポートされておらず、RDSを利用してORACLEをデータベースエンジンとしてもRACを使用することはできないが、AWSマーケットプレイス上のAMIを使ってRACをAmazon EC2上にデプロイすることが可能になった。
### RMAN の復元は Amazon RDS for Oracle の DB インスタンスでサポートされていない
RDSのOracleエンジンではRMANによるバックアップ自体は設定可能だが、復元はサポートされてない

## ログ
### MySQL
MySQLでは、エラーログ、スロークエリログ、一般ログの3つのログをモニタリングできます。MySQL エラーログはデフォルトで生成されます。
DB パラメータグループのパラメーターを設定することで、スロークエリと一般ログを生成できます。
ログの中でも、トラブルシューティングのために実行に時間がかかったすべてのSQLステートメント内容を収集することができるのはスロークエリログ

#### エラーログ
エラーログには mysqld が開始および停止された時期を示す情報と、サーバーが実行中に発生したあらゆるクリティカルエラーが格納されます。
自動的にチェックまたは修復することが必要なテーブルが mysqld で検出された場合、エラーログに警告メッセージが書き込まれます。
#### 一般ログ
mysqld の実行内容の一般的な記録です。サーバーは、クライアントが接続または接続解除したときに情報をこのログに書き込み、クライアントから受け取った各 SQL ステートメントをログに記録します。一般クエリーログは、クライアント側でエラーが疑われるとき、クライアントが mysqld に送信した内容を正確に知りたい場合に非常に役立つことがあります。

#### スロークエリログ
スロークエリーログは、実行に要した時間が long_query_time 秒を超え、少なくとも min_examined_row_limit 行を検査する必要があった SQL ステートメントで構成されます。long_query_time の最小値およびデフォルト値は、それぞれ 0 および 10 です。値はマイクロ秒の精度まで指定できます。ファイルへのロギングの場合、時間はマイクロ秒の部分も含めて書き込まれます。テーブルへのロギングの場合、時間の整数部のみ書き込まれ、マイクロ秒の部分は無視されます。

## マルチAZ
Amazon RDS マルチ AZ 配置は、データベース（DB）インスタンスの拡張された可用性と持続性を提供し、運用データベース作業負荷に自然に適合させます。Multi-AZ DB インスタンスをプロビジョニングすると、Amazon RDS はプライマリ DB インスタンスを自動的に作成するのと同時に、異なるアベイラビリティーゾーン (AZ) にあるスタンバイインスタンスにデータを複製します。
各アベイラビリティーゾーンは、その独自の、物理的にはっきりと独立したインフラストラクチャ上で稼動しています。また高い信頼性を保つように設計されています。インフラストラクチャ障害の場合、Amazon RDS はスタンバイ (Amazon Aurora の場合はリードレプリカ) に自動的にフェイルオーバーするので、フェイルオーバーが完了するとすぐにデータベースの動作を再開できます。
スタンバイ（スレーブ）は冗長化のための仕組みなので書き込み・読み込みアクセスはできない。

## リードレプリカ
別のリージョンにリードレプリカを配置することが可能で、災害発生時にそのリードレプリカをマスターとして昇格させることが可能。（Auroraと違ってフェイルオーバーはしない）

## RDSで書き込み負荷に対応するには
インスタンスタイプを大きいものにする

## RDS on VMware
`オンプレミスのVMware vSphere環境`でのデータベース管理に、AWS 環境と同じシンプルなインターフェイスを利用できる
自動バックアップの取得や世代の設定やOSとデータベースエンジンへのパッチ適用がサポートされる
AWS環境のRDSと同様に、RDSコンソール、API、またはCLIを使用してRDSデータベースを管理できる

# DynamoDB
リザーブドキャパシティがあり、割安な価格で運用することができる。

## パーティショニング
パーティショニングとは、論理的には一つの大きなテーブルであるものを、物理的により小さな部品に分割すること（DBの一般的な機能でRDBMSにもある）

## セカンダリインデックス
テーブル内のデータに効率的にアクセスするため、DynamoDB はPrimary Key属性用にインデックスを作成して維持する。Primary Keyの値を指定することで、迅速にデータを取得することができる。
しかし、Primary Key以外の属性を使用する場合もある、その場合データに効率的にアクセスできるようにするセカンダリインデックスを指定する。, mjyyyyhhhhhhhhhhhhh666666666jjjjj666666666666jjjjjj...¿¿¿¿¿¿

### ローカルセカンダリインデックス
パーティションキーはベーステーブルと同じですが、ソートキーが異なるインデックスです。ローカルセカンダリインデックスは、ローカルセカンダリインデックスのすべてのパーティションの範囲が、同じパーティションキー値を持つベーステーブルのパーティションに限定されるという意味で「ローカル」です。その結果、任意の 1 つのパーティションキー値に対してインデックスが作成された項目の合計サイズが、10 GB を超えることはできません。また、ローカルセカンダリインデックスでは、読み込みアクティビティおよび書き込みアクティビティのプロビジョニングされたスループット設定が、インデックス作成中のテーブルと共有されます
ローカルセカンダリインデックスの目的は、パーティションキーの値が同じで、ソートキーの値が異なる項目に対してクエリを実行すること
よくわからない場合は参考資料を参照

### グローバルセカンダリインデックス
パーティションキーおよびソートキーを持つインデックスです。ベーステーブルのものとは異なる場合があります。グローバルセカンダリインデックスは、このインデックスに関するクエリが、すべてのパーティションにまたがり、ベーステーブル内のすべてのデータを対象とする可能性があるため、「グローバル」と見なされます。グローバルセカンダリインデックスにはサイズの制限はなく、読み込みアクティビティと書き込みアクティビティ用にプロビジョニングされた独自のスループット設定が、テーブルのものとは異なります。
インデックス用に新たにパーティションキーとソートキーを指定して検索できるようになる。つまり、`物理パーティションに囚われない検索が可能`

## 参考資料
[DynamoDBの構造まとめ](https://qiita.com/blackcat5016/items/c2af7d3d55093134bac3)


## グローバルテーブル
Amazon DynamoDB グローバルテーブルは、マルチリージョンにマルチマスターデータベースをデプロイするための完全マネージド型のソリューションです。独自のレプリケーションソリューションを構築および管理する必要はありません。グローバルテーブルを作成する際、そのテーブルの利用を許可する AWS リージョンを指定します。DynamoDB は、これらのリージョンに同一のテーブルを作成するのに必要なすべてのタスクを実行し、変更中のデータをすべてのテーブルに伝達します。（stremasを有効にする必要がある）

## DynamoDB Steams
DynamoDB テーブルに保存された項目の変更を、変更の発生を検知できる。
### streamsを使ったテーブルのレプリケーション
DynamoDB Streamsを有効化します。その上で、該当するシンガポールリージョンにも同じテーブルを作成して、各リージョンにおける個別のトランザクション処理結果がレプリケーションされるように設定する。

## オンデマンドキャパシティ設定
テレビのリアルタイム投票など利用者が急激に増えるスパイクが起こるようなサービスなどで、スケーリングの設定をauto scalingではなくオンデマンドキャパシティ設定にすることによって、スパイクに対応できる。
料金はリクエスト数に対しての課金

## DynamoDB Auto Scaling
実際のトラフィックパターンに応じてプロビジョンドスループット性能をユーザーに代わって動的に調節
手動でスケーリングの上限と下限を設定しないといけない
（オンデマンドの場合は勝手に思いがけないキャパシティになってしまうこともあるがAuto Scalingではスケーリングが追いつかない時もある　Auto Scalingの方が古い機能）

## キャパシティモード
### オンデマンド
容量計画なしで 1 秒あたりに数千ものリクエストを処理できる柔軟な請求オプション
### Provisioned Mode
アプリケーションに必要な 1 秒あたりの読み込みと書き込みの回数を指定
#### 読み込みキャパシティーユニット（RCU）の計算方法
1つの読み込みキャパシティーユニットは、最大サイズ `4 KB` の項目について、`1 秒あたり 1 回の強力な整合性のある読み込み、あるいは 1 秒あたり 2 回の結果整合性のある読み込み`を表します。 
例えば、10 ユニットのプロビジョニングされた読み取りキャパシティーでテーブルを作成するとします。これにより、最大 4 KB の項目について、1 秒あたり 10 回の強い整合性のある読み込み、または 20 回の結果的に整合性のある読み込みを行えます。 

4 KB を超える項目の読み込みには、より多くの読み取りキャパシティーユニットを消費します。たとえば、8 KB (4 KB × 2) の項目の強い整合性のある読み込みは、2 ユニットの読み込みキャパシティーユニットを消費します。同じ項目の結果的に整合性のある読み込みは、読み込みキャパシティーを 1 ユニットしか消費しません。 

したがって、RCUは10 ユニットのプロビジョニングされた読み取りキャパシティーでテーブルに対して、 20 回の結果的に整合性のある読み込みを行えるため、10RCUが正しい設定となります。 

#### 書き込みキャパシティーユニット（WCU）の計算方法

1 つの書き込みキャパシティーユニットは、`最大サイズが 1 KB の項目について、1 秒あたり 1 回の書き込み`を表します。

例えば、10 ユニットのプロビジョニングされた書き込みキャパシティーでテーブルを作成するとします。これにより、1 秒あたり最大でサイズが 1 KB の項目について、1 秒あたり 10 回の書き込みを行えます。

書き込みの項目サイズは、次の 1 KB の倍数に切り上げられます。たとえば、500 バイトの項目の書き込みは、1 KB の項目の書き込みと同じスループットを消費します。 

したがって、WCUは30 ユニットのプロビジョニングされた読み取りキャパシティーのテーブルに対して、 1 秒あたり最大でサイズ1 KB の項目について、1 秒あたり 30 回の書き込みを行えます。

デフォルト上限は40000

#### ProvisionedThroughputExceededException
リクエストスループットは、プロビジョニングされた容量を超えると調整され、リクエストが失敗します。その際にProvisionedThroughputExceededExceptionという例外エラー表示が発生する。

## FGAC(Fine Grained Access Control）
DynamoDBがセキュリティ、アクセス制限を実現する仕組み
DynamoDB テーブルの所有者がテーブル内のデータに対して詳細なコントロールを行うための機能です。具体的には、テーブル所有者は誰（呼び出し元）がテーブルのどの項目や属性にアクセスでき、どのようなアクション（読み込み/書き込み）を実行できるかを指定できます。

## DAX
キャッシュを利用したテーブル内のデータ処理を高パフォーマンス化する機能です。これは一時的な高パフォーマンスではなく、DAXが起動している間定常的にパフォーマンスをキープすることになる
高コスト

## パフォーマンスの向上
DynamoDB はデータをパーティションに保存します。パーティションは、ソリッドステートドライブ (SSD) によってバックアップされ、AWS リージョン内の複数のアベイラビリティーゾーン間で自動的にレプリケートされる、テーブル用のストレージの割り当てです。パーティション管理は完全に DynamoDB によって処理されます。I / O要求を均等に分散しないパーティションキー設計では、「ホット」パーティションが作成されてスロットルが発生し、プロビジョニングされたI / O容量が非効率的に使用される可能性があります。

DynamoDB は次の状況でテーブルに追加のパーティションを割り当てます
- テーブルのプロビジョニングされたスループット設定を、既存のパーティションがサポートできる以上に増やす。
- 既存のパーティションが容量いっぱいになり、より多くのストレージ領域が必要になる。

一般に、パーティションキー値の総数に対するアクセスされたパーティションキー値の比率が高いほど、プロビジョニングされたスループットをより効率的に使用します。その一例として、カーディナリティの高い属性を持つパーティションキーを使用することが挙げられます。これには、各項目に多数の異なる値があります。テーブルにカラムがあるとして、カラムに格納されているデータの種類がどのくらいあるのか(カラムの値の種類の絶対値)を、カーディナリティといい、「カラムのデータの種類が、テーブルのレコード数に比べて多い場合、 カーディナリティが高い」といいます。
UUIDはカーディナリティ高い
性別カラムはカーディナリティ低い


# DMS(AWS Database Migration Service)
AWS Database Migration Serviceのテーブルマッピングにより、データソース、ソーススキーマ、データ、そしてタスク実行中に必要なすべての変換を指定するための複数のルールタイプを使用します。テーブルマッピングを使用して、データベースで移行する個々のテーブルや、移行に使用するスキーマを指定できます。また、フィルタを使用して、レプリケートする特定テーブルの列からデータを指定でき、変換を使用してターゲットデータベースに書き込むデータを変更できる。

AWS Database Migration Serviceコンソールから、移行タスクを定義して、実行する詳細設定が可能となっています。

テーブルマッピングはJSON 形式で作成されます。AWS DMS マネジメントコンソールを使用して移行タスクを作成する場合、JSON を直接テーブルマッピングボックスに入力できます。CLI または API を使用して移行を実行する場合、JSON ファイルを作成して移行中に適用するテーブルマッピングを指定できます。

## 移行手順
1. レプリケーションインスタンスを配置する、Replication Subnet Groupを作成する
1. ソースデータベースからターゲットデータベースにデータを割り当てて移行するタスクを実行するのに十分なストレージと処理能力を持つレプリケーションインスタンスを作成する
1. ソースエンドポイントにオンプレのデータベースを指定し、ターゲットデータベースにRDSを指定する。（endpoint設定）
1. migrate existing data（初期転送のみ）などのtask設定を行う

# ElastiCache
キャッシュサーバー
## Redis
NoSQL
リアルタイムデータの計算処理などはRedisを使う
ゲームサービスの場合はRedisを使うことが多いらしい
レプリケーション機能がある(高可用性)
Replication Group を作って、5台までリードレプリカを作成可能
スナップショット を作成してS3に置いておくことが可能

- 位置情報クエリ
位置情報クエリは経度・緯度などの位置情報をクエリ処理することが可能で、検索距離や検索範囲の指定可能
- Luaスクリプトによる操作
Luaスクリプトというスクリプト言語を使って操作が可能でこれは移植性が高い
- pub/subモデルを活用可能
pub/subモデルは「イベントを起こす側」と「イベント処理を行う側」を分離するのがpub/subモデルなのですが、メッセージ処理やイベント処理で活用することができます。
- 単一ノードはシングルスレッド
- スナップショット作成可能

### Redis Cluster(新機能)
データをシャード単位に分け分散保存
ノードの数を加減することで負荷の分散が可能
マルチAZ構成

## Memcached
できるだけシンプルな構成にしたい場合
システムでの需要の増減に応じてノードを追加または削除するスケールアウトおよびスケールイン機能が必要である場合
セッションデータなど単純な処理の場合はmemcahedを使う

- 対応できるデータ型がStringのみ
- レプリケーション機能はない（バックアップ機能もない)
- 単一ノードはマルチスレッド
### Auto Discavery(自動検出)
Memcachedの機能でクライアントライブラリはendpointだけを参照しておけば、ライブラリがサーバと定期的にやりとりをしてendpointの配下のノードの状態を内部で管理してくれるため、
アプリケーションコードからはノードの増減にかかわるやりとりや管理についてのコードを一掃することができる。

[RedisとMemcachedとの比較](https://dev.classmethod.jp/articles/which-choice-redis-memcached/)

# Redshift
さまざまなデータ源からデータを収集・統合・蓄積し、分析のため保管しておくシステムです。伝統的なRDBMSとは違って、継続的な書き込みや更新には向いておらず、一括でデータを書き込み分析のため大容量データを読み出すという処理に最適化している。
DWH(データウェアハウス)
標準 SQL および既存のビジネスインテリジェンス (BI) ツールを使用して、すべてのデータをシンプルかつコスト効率よく分析できる。
クエリ最適化、高パフォーマンスストレージでの列指向ストレージ、および並列クエリ実行を使用して、ペタバイト単位の構造化データに対して複雑な分析クエリを実行可能
Postgreベース
列指向ストレージ
全てのデータはS3にある。よく使用されるデータはローカルSSDにキャッシュされている

Redshiftクラスターは3つのコンポーネントで構成されている
## リーダーノード
アプリケーションからクエリを受け付けるサーバー
SQLをコンパイルする

ずっと使う場合リザーブドインスタンス使えば安くなる
## コンピュートノード
クエリの処理を並列で処理する
データをキャッシュで保持する
コンピュートノードを追加することでパフォーマンスが向上する
オンデマンドインスタンスを使う

## マネージドストレージ
Redshift管理のS3でRedshiftのデータフォーマットで保存されている

## クロスリージョンスナップショット
スナップショットはS3に保存されるが、直接操作することはできない。別リージョンにスナップショットを転送するクロスリージョンスナップショット機能を使って可用性を高める。

## ワークロード管理（WLM）
ワークロード内の優先順位を柔軟に管理して、短くて実行速度の速いクエリが実行時間の長いクエリの後に溜まらないようにできます。
スロット　メモリとCPUの単位
キュー　各クエリがキューに割り当てられる
自動で並列スロット数を決定される

ワークロード内の優先順位を柔軟に管理して、短くて実行速度の速いクエリが実行時間の長いクエリの後に溜まらないようにできます。 これにより、２つの異なるワークロード管理グループを作成して、2つのデータ分析プロセスを設定することができる。

サービスクラスに従って実行時にクエリキューを作成します。サービスクラスでは、内部システムキューやユーザーアクセス可能キューなどのさまざまな種類のキューに対する設定パラメータが定義されています。ユーザーから見た場合、ユーザーアクセス可能サービスクラスとキューは機能的に同じものです。一貫性を保つため、このドキュメントでは、ユーザーアクセス可能サービスクラスとランタイムキューを表すために、キューという用語を使用します。 
ユーザーがクエリを実行すると、WLM はユーザーのユーザーグループに従ってクエリをキューに割り当てるか、キューの設定でリストされているキューグループとユーザーが実行時に設定したキューグループラベルを照合することによってクエリをキューに割り当てます。

## Elastic Resize
コンピュートとストレージをオンデマンドでスケールできる
スケジュール設定可能

## コンカレンシースケーリング
クエリキュー待ちが発生するとバックグラウンドで別のクラスターを立ち上げて、大きなコンピューティングリソースで処理可能

## Redshift Spectrum
データをRedshiftのテーブルにロードすることなく直接S3のバケットのエクサバイト単位の非構造化データに対してに対してクエリを実行できるという機能
データレイクになっているS3から直接クエリを実行できる便利機能
S3のデータとRedshiftのデータを結合することも可能

Athena・BigQueryとよく似た機能
大規模データを複数クラスタで処理したい場合はAthenaよりRedshiftの方が適切か

## データレイクエクスポート
RedshiftテーブルデータをS3上へApache Parquet形式でエクスポート可能
AthenaやEMRなどのサービスで分析可能になる

## データのロード
S3とかEMR DynamoDBからCOPYコマンドを使ってRedshiftにデータを並列ロードすることができる。

## Redshiftの可用性を高めるには
シングル AZ 配置のみでマルチAZは無理
なので可用性を高めたい場合は複数のアベイラビリティーゾーンで運用するには、2 つの Amazon Redshift データウェアハウスクラスターをそれぞれ別のアベイラビリティーゾーンに配置し、同じ Amazon S3 入力ファイルセットからデータをロードするようにする
スナップショットをとっておいてDR用のクラスターに適用する。

## 「クエリがハングする」ことへの対処方
起動後に問題なく動いていたたはずのRedshiftで、しばらくしてクエリがまったく応答しなくなるトラブルのこと

- データベースへの接続が中断された 最大送信単位 (MTU) のサイズを小さくします。MTU サイズにより、ネットワーク接続を介して 1 つのイーサネットフレームで転送できるパケットの最大サイズ (バイト単位) が決まります。

- データベースへの接続がタイムアウトした COPY コマンドなどの長いクエリを実行すると、データベースへのクライアント接続がハングまたはタイムアウトしているように見えます。この場合、Amazon Redshift コンソールにはクエリが完了したと表示されますが、クライアントツール自体はまだクエリを実行しているように見えることがあります。接続がいつ停止したかに応じて、クエリの結果がないか、不完全になる可能性があります。この効果は、中間ネットワークコンポーネントによってアイドル接続が終了すると発生します。

- ODBC 使用時にクライアント側のメモリ不足エラーが発生する クライアントアプリケーションが ODBC 接続を使用し、クエリで作成される結果セットが大きすぎてメモリが足りなくなる場合、カーソルを使用して、結果セットをクライアントアプリケーションに渡すことができます。(ODBCとはDBMSに接続するためのAPI 共通インターフェイス)

- JDBC 使用時にクライアント側のメモリ不足エラーが発生する JDBC 接続で大規模な結果セットを取得しようとすると、クライアント側のメモリ不足エラーが発生する可能性があります。 （JDBCとはJava Database Connectivityの略で、Javaアプリケーションからデータベースを操作するAPI）


## クラスターが暗号化されているRedshiftにおいて、DR対応として違うリージョンにスナップショットを置いておく場合
Amazon Redshiftクラスターを起動するときに、AWS KMSのマスターキーで暗号化することを選択できます。その際の AWS KMSキーはリージョンに固有となります。DR元リージョンにおいてAWS KMSで暗号化されたクラスターのクロスリージョンスナップショットコピーを有効にすることで、DR対象となるリージョンに対して、Redshiftクラスターのスナップショットをコピーして移転させることができます。
この設定には、Amazon Redshiftが宛先リージョンで暗号化操作を実行できるように、宛先リージョンのマスターキーのスナップショットコピーを許可する設定が必要です。Amazon Redshiftのスナップショットはクラスターのポイントインタイムバックアップです。スナップショットには、自動と手動の 2 つのタイプがあります。Amazon Redshift は、暗号化された SSL接続を使用して、これらのスナップショットを Amazon S3 の内部に保存できます。 
