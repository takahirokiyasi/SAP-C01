# IPv6対応
EC2インスタンスがIPv6を介してインターネットと通信できるようにするには、VPCで次の設定を行う必要があります。

IPv6を有効にする手順
1. IPv6 CIDRブロックをVPCおよびサブネットに関連付ける
Amazonが提供するIPv6 CIDRブロックをVPCおよびサブネットに関連付けます。 
その際には、/16 の IPv4 CIDR ブロックを持つ VPC を作成し、/56 の IPv6 CIDR ブロックを VPC と関連付けます。IPv6 CIDR ブロックのサイズ (/56) は固定されており、IPv6 アドレスの範囲は、Amazon の IPv6 アドレスのプールから自動的に割り当てられます (独自の IPv6 アドレス範囲を指定することはできません)。 

1. ルートテーブルを更新する
ルートテーブルを更新して、IPv6トラフィックをルーティングします。パブリックサブネットの場合、すべてのIPv6トラフィックをサブネットからインターネットゲートウェイにルーティングするルートを作成します。プライベートサブネットの場合、インターネットからのすべてのIPv6トラフィックをサブネットから出力専用のインターネットゲートウェイにルーティングするルートを作成します。 

1. セキュリティグループルールを更新する
セキュリティグループルールを更新して、IPv6アドレスのルールを含めます。これにより、インスタンスとの間でIPv6トラフィックが流れるようになります。サブネットとの間のトラフィックのフローを制御するカスタムネットワークACLルールを作成した場合、IPv6トラフィックのルールを含める必要があります。 

1. インスタンスタイプの変更
インスタンスタイプがIPv6をサポートしていない場合は、インスタンスタイプを変更します。インスタンスタイプがIPv6をサポートしていない場合、インスタンスのサイズをサポートされているインスタンスタイプに変更する必要があります。この例では、インスタンスはm3.largeインスタンスタイプであり、IPv6をサポートしていません。インスタンスのサイズを、サポートされているインスタンスタイプ（m4.largeなど）に変更する必要があります。 

1. インスタンスにIPv6アドレスを割り当てる
サブネットのIPv6アドレス範囲からインスタンスにIPv6アドレスを割り当てます。

1. インスタンスでIPv6を構成する
DHCPv6を使用するように構成されていないAMIからインスタンスを起動した場合、インスタンスに割り当てられたIPv6アドレスを認識するようにインスタンスを手動で構成する必要があります。

## ルーティング
プライベートサブネットの場合、サブネットからEgress-onlyインターネットゲートウェイにインターネット経由の IPv6 トラフィックをすべてルーティングするルートを作成  
パブリックサブネットの場合、サブネットからインターネットゲートウェイに IPv6 トラフィックをすべてルーティングするルートを作成
## Security Group and ACL
IPv6アドレスのルールを含めて、セキュリティグループルールを更新する、これにより、IPv6トラフィックはインスタンスに出入りできるようになる。カスタムネットワークACLルールを作成して、サブネットに出入りするトラフィックの流れを制御している場合は、ACLにもIPv6トラフィックのルールを含める必要がある。

## VPC サブネット
IPv6　CIDRをVPCとサブネットに紐付ける。

# オンプレミス環境で利用しているパブリックIPv4アドレス範囲をオンプレミスネットワークからVPCに移行する方法

# Cloud Frontを利用していてHttp 504 エラーが発生している場合
グローバルなコンテンツ配信処理のパフォーマンスが低下している。
## Lambda Edgeの使用
Lambda Edgeを使用して、Lambda関数でCloudFrontが配信するコンテンツをカスタマイズし、ユーザーに近いAWSロケーションで認証プロセスを実行できます。これによって、グローバルなユーザーに適した認証プロセスが実施できることでモバイルアプリケーションのログイン遅延に対応することができる
## Cloudfrontのセカンドオリジンを設定する
もう1つをプライマリオリジンに障害が発生したときにCloudFrontが自動的に切り替える2番目のオリジンとして2つのオリジンを持つオリジングループを作成することにより、オリジンフェールオーバーを設定できる。
これにより、不定期のHTTP 504エラーが軽減

※Route 53の位置情報ルーティングでは遅延は解消されない（コンテンツのローカライズに普通は使用）

# ドメインが追加されるたびに証明書を発行＆プロビジョニングする必要がないようにALBを設定するにはSNI（Server Name Indication）を使用する
ACMコンソールを使用してALBのドメインのすべてのSSL証明書を追加し、複数の証明書をロードバランサーの同じセキュアリスナーにバインドします。
ALBは、Server Name Indication（SNI）を使用して、各クライアントに最適なTLS証明書を自動的に選択します。

https://dev.classmethod.jp/articles/alb-support-sni/

# cloudfrontでThe request could not be satisfied.Bad Request.のエラー
- リクエストが HTTP を通じて開始されたが、CloudFront ディストリビューションは HTTPS のリクエストだけを許可するように設定されている。この場合は、ビューワーのプロトコルポリシーにおいて、[HTTP and HTTPS  または Redirect HTTP to HTTPSのいずれかを選択します。したがって、オプション２が正解となります。

- リクエストされた代替ドメイン名 (CNAME) が CloudFront ディストリビューションと関連付けられていない。この場合はloudFront ディストリビューションと関連付ける CNAME を入力します。
